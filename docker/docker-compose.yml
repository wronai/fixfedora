version: "3.9"

# ═══════════════════════════════════════════════════════════
#  fixos – środowiska testowe (Docker)
#  Użycie:
#    docker compose build
#    docker compose run broken-audio      # testuj audio
#    docker compose run broken-thumbnails # testuj thumbnails
#    docker compose run broken-full       # pełny test
#    docker compose run e2e-tests         # uruchom testy e2e
# ═══════════════════════════════════════════════════════════

x-common: &common
  build:
    context: ..
  volumes:
    - ..:/app:ro
    - /tmp/fixos-test-reports:/reports
  env_file:
    - ../.env
  environment:
    - FIXOS_TEST_MODE=1
    - REPORTS_DIR=/reports
  networks:
    - fixos-test

services:

  # ── Obraz bazowy (nie uruchamiany bezpośrednio) ────────
  base:
    build:
      context: ..
      dockerfile: docker/base/Dockerfile
    image: fixos-base:latest
    profiles: ["build-only"]
    command: echo "base image built"

  # ── Uszkodzony dźwięk ──────────────────────────────────
  broken-audio:
    <<: *common
    build:
      context: ..
      dockerfile: docker/broken-audio/Dockerfile
    image: fixos-broken-audio:latest
    container_name: fixos-broken-audio
    environment:
      - SCENARIO=broken-audio
      - AUDIO_BROKEN=1
      - FIXOS_TEST_MODE=1
    command: >
      sh -c "
        echo '=== Scenariusz: broken-audio ===' &&
        verify-scenario.sh &&
        python3 -m fixos.diagnostics.system_checks
      "

  # ── Uszkodzone thumbnails ──────────────────────────────
  broken-thumbnails:
    <<: *common
    build:
      context: ..
      dockerfile: docker/broken-thumbnails/Dockerfile
    image: fixos-broken-thumbnails:latest
    container_name: fixos-broken-thumbnails
    environment:
      - SCENARIO=broken-thumbnails
      - THUMBNAILS_BROKEN=1
      - FIXOS_TEST_MODE=1

  # ── Uszkodzona sieć ───────────────────────────────────
  broken-network:
    <<: *common
    build:
      context: ..
      dockerfile: docker/broken-network/Dockerfile
    image: fixos-broken-network:latest
    container_name: fixos-broken-network
    environment:
      - SCENARIO=broken-network
      - NETWORK_BROKEN=1
      - DNS_BROKEN=1
      - RFKILL_BLOCKED=1
      - FIXOS_TEST_MODE=1
    command: >
      sh -c "
        echo '=== Scenariusz: broken-network ===' &&
        verify-scenario.sh &&
        python3 /usr/local/bin/simulate-network-diag.py
      "

  # ── Pełne uszkodzenie ─────────────────────────────────
  broken-full:
    <<: *common
    build:
      context: ..
      dockerfile: docker/broken-full/Dockerfile
    image: fixos-broken-full:latest
    container_name: fixos-broken-full
    environment:
      - SCENARIO=broken-full
      - AUDIO_BROKEN=1
      - THUMBNAILS_BROKEN=1
      - NETWORK_BROKEN=1
      - SERVICES_FAILED=1
      - DNF_UPDATES_PENDING=4
      - FIXOS_TEST_MODE=1

  # ── Runner testów e2e ─────────────────────────────────
  e2e-tests:
    <<: *common
    build:
      context: ..
      dockerfile: docker/base/Dockerfile
    container_name: fixos-e2e
    environment:
      - FIXOS_TEST_MODE=1
      - PYTEST_ADDOPTS="-v --tb=short"
    command: >
      sh -c "
        pip install pytest pytest-cov pytest-mock --quiet &&
        python -m pytest tests/e2e/ tests/unit/ -v --tb=short
          --cov=fixos --cov-report=term-missing
          --cov-report=html:/reports/coverage
          -m 'not real_api'
      "
    depends_on:
      - base

  # ── Unit testy (bez Dockera środowisk) ────────────────
  unit-tests:
    <<: *common
    build:
      context: ..
      dockerfile: docker/base/Dockerfile
    container_name: fixos-unit
    command: >
      sh -c "
        pip install pytest pytest-mock --quiet &&
        python -m pytest tests/unit/ -v --tb=short
          --cov=fixos --cov-report=term-missing
      "

  # ── Testy CLI (izolowane) ─────────────────────────────
  cli-tests:
    <<: *common
    build:
      context: ..
      dockerfile: docker/base/Dockerfile
    container_name: fixos-cli-tests
    command: >
      sh -c "
        pip install pytest pytest-mock --quiet &&
        python -m pytest tests/e2e/test_cli.py tests/e2e/test_executor.py -v --tb=short
      "

networks:
  fixos-test:
    driver: bridge

volumes:
  test-reports:
